name: Release and Build

on:
  push:
    branches:
      - main

jobs:
  version-and-release:
    name: Version Bump and Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semantic.outputs.new_release_version }}
      released: ${{ steps.semantic.outputs.new_release_published }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@latest \
            @semantic-release/git@latest \
            @semantic-release/changelog@latest \
            @semantic-release/exec@latest \
            conventional-changelog-conventionalcommits@latest

      - name: Create semantic-release config
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": ["main"],
            "plugins": [
              [
                "@semantic-release/commit-analyzer",
                {
                  "preset": "conventionalcommits",
                  "releaseRules": [
                    {"type": "chore", "release": "major"},
                    {"type": "feat", "release": "minor"},
                    {"type": "fix", "release": "patch"},
                    {"type": "perf", "release": "patch"},
                    {"type": "docs", "release": false},
                    {"type": "style", "release": false},
                    {"type": "refactor", "release": false},
                    {"type": "test", "release": false}
                  ]
                }
              ],
              [
                "@semantic-release/release-notes-generator",
                {
                  "preset": "conventionalcommits"
                }
              ],
              [
                "@semantic-release/changelog",
                {
                  "changelogFile": "CHANGELOG.md"
                }
              ],
              [
                "@semantic-release/exec",
                {
                  "prepareCmd": "./scripts/update-version.sh ${nextRelease.version}"
                }
              ],
              [
                "@semantic-release/git",
                {
                  "assets": [
                    "CHANGELOG.md",
                    "pubspec.yaml",
                    "android/app/build.gradle",
                    "ios/Runner/Info.plist"
                  ],
                  "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
                }
              ],
              [
                "@semantic-release/github",
                {
                  "assets": []
                }
              ]
            ]
          }
          EOF

      - name: Create version update script
        run: |
          mkdir -p scripts
          cat > scripts/update-version.sh << 'EOF'
          #!/bin/bash
          set -e

          NEW_VERSION=$1
          if [ -z "$NEW_VERSION" ]; then
            echo "Error: No version provided"
            exit 1
          fi

          echo "Updating version to $NEW_VERSION"

          # Update pubspec.yaml
          # Extract current build number
          CURRENT_BUILD=$(grep -oP 'version: \d+\.\d+\.\d+\+\K\d+' pubspec.yaml || echo "1")
          NEW_BUILD=$((CURRENT_BUILD + 1))
          sed -i "s/version: .*/version: $NEW_VERSION+$NEW_BUILD/" pubspec.yaml
          echo "âœ“ Updated pubspec.yaml to $NEW_VERSION+$NEW_BUILD"

          # Update Android version
          # versionName
          sed -i "s/versionName \".*\"/versionName \"$NEW_VERSION\"/" android/app/build.gradle
          # versionCode (increment)
          CURRENT_VERSION_CODE=$(grep -oP 'versionCode \K\d+' android/app/build.gradle || echo "1")
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
          sed -i "s/versionCode .*/versionCode $NEW_VERSION_CODE/" android/app/build.gradle
          echo "âœ“ Updated Android to versionName $NEW_VERSION, versionCode $NEW_VERSION_CODE"

          # Update iOS version
          # CFBundleShortVersionString
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $NEW_VERSION" ios/Runner/Info.plist 2>/dev/null || \
          plutil -replace CFBundleShortVersionString -string "$NEW_VERSION" ios/Runner/Info.plist

          # CFBundleVersion (use build number)
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" ios/Runner/Info.plist 2>/dev/null || \
          plutil -replace CFBundleVersion -string "$NEW_BUILD" ios/Runner/Info.plist

          echo "âœ“ Updated iOS to $NEW_VERSION ($NEW_BUILD)"

          echo "Version update complete!"
          EOF

          chmod +x scripts/update-version.sh

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

  build-android:
    name: Build Android (APK & AAB)
    runs-on: ubuntu-latest
    needs: version-and-release
    if: needs.version-and-release.outputs.released == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Build APK
        run: flutter build apk --release --dart-define=FLAVOR=prod

      - name: Build App Bundle (AAB)
        run: flutter build appbundle --release --dart-define=FLAVOR=prod

      - name: Rename artifacts
        run: |
          VERSION="${{ needs.version-and-release.outputs.version }}"
          cp build/app/outputs/flutter-apk/app-release.apk "timely-v${VERSION}.apk"
          cp build/app/outputs/bundle/release/app-release.aab "timely-v${VERSION}.aab"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            timely-v*.apk
            timely-v*.aab
          retention-days: 90

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-and-release.outputs.version }}
          files: |
            timely-v*.apk
            timely-v*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    name: Build iOS (IPA)
    runs-on: macos-latest
    needs: version-and-release
    if: needs.version-and-release.outputs.released == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Build iOS (no code signing)
        run: |
          flutter build ios --release --dart-define=FLAVOR=prod --no-codesign

      - name: Create IPA archive
        run: |
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r app-release.ipa Payload
          cd ../../..
          VERSION="${{ needs.version-and-release.outputs.version }}"
          cp build/ios/iphoneos/app-release.ipa "timely-v${VERSION}.ipa"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-builds
          path: timely-v*.ipa
          retention-days: 90

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-and-release.outputs.version }}
          files: timely-v*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    name: Notify Build Completion
    runs-on: ubuntu-latest
    needs: [version-and-release, build-android, build-ios]
    if: always() && needs.version-and-release.outputs.released == 'true'

    steps:
      - name: Build Status Summary
        run: |
          echo "## ðŸš€ Release v${{ needs.version-and-release.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Android Build: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS Build: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the [release page](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-and-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
